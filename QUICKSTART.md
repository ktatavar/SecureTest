# Wiz Technical Exercise - Quick Start Guide

This guide provides a streamlined path to deploy the entire environment with maximum automation.

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Automated Setup](#automated-setup)
3. [Deploy Infrastructure](#deploy-infrastructure)
4. [Deploy Application](#deploy-application)
5. [Verification & Demonstration](#verification--demonstration)
6. [Cleanup](#cleanup)

---

## Prerequisites

### Required Tools

Install these tools before starting:

```bash
# Install AWS CLI (if not already installed)
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Install Terraform
wget https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
unzip terraform_1.9.0_linux_amd64.zip
sudo mv terraform /usr/local/bin/

# Install kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Install Docker (for local testing)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Verify installations
aws --version
terraform --version
kubectl version --client
docker --version
```

### AWS Account Setup

You need an AWS account with:
- ✅ Admin or sufficient IAM permissions
- ✅ AWS CLI configured with credentials
- ✅ Access to create VPCs, EC2, EKS, S3, IAM roles

**Configure AWS CLI:**
```bash
aws configure
# Enter your:
# - AWS Access Key ID
# - AWS Secret Access Key
# - Default region: us-east-1
# - Default output format: json
```

**Verify AWS access:**
```bash
aws sts get-caller-identity
```

### GitHub Setup (Optional - for CI/CD)

If using GitHub Actions:

1. Fork or clone this repository
2. Set up repository secrets:
   - `AWS_ACCOUNT_ID` - Your 12-digit AWS account ID
3. Configure OIDC provider (see `GITHUB_ACTIONS_SETUP.md`)

---

## Automated Setup

We provide an automated setup script that handles most of the configuration:

### Run the Automated Setup Script

```bash
./scripts/setup-prerequisites.sh
```

This script will:
- ✅ Verify all required tools are installed
- ✅ Check AWS credentials
- ✅ Create terraform.tfvars from template
- ✅ Generate unique S3 bucket name
- ✅ Detect your region and AMI
- ✅ Configure default values

### Manual Configuration (if needed)

If you need to customize settings, edit `terraform/terraform.tfvars`:

```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars
```

**Required changes:**
- `project_name` - Your project name (default: "wiz-exercise")
- `environment` - Environment name (default: "dev")
- `mongodb_backup_bucket` - Must be globally unique (auto-generated by script)
- `aws_region` - Your AWS region (default: "us-east-1")

---

## Deploy Infrastructure

### Option 1: Automated Deployment (Recommended)

Use our automated deployment script:

```bash
./scripts/deploy-all.sh
```

This single command will:
1. ✅ Deploy infrastructure with Terraform
2. ✅ Wait for resources to be ready
3. ✅ Extract MongoDB IP address
4. ✅ Update Kubernetes configurations
5. ✅ Configure kubectl
6. ✅ Deploy application to Kubernetes
7. ✅ Wait for pods to be ready
8. ✅ Display access URLs and verification commands

**Estimated time:** 20-30 minutes

### Option 2: Manual Step-by-Step Deployment

If you prefer manual control:

#### Step 1: Deploy Infrastructure (15-20 minutes)

```bash
cd terraform

# Initialize Terraform
terraform init

# Review the plan
terraform plan

# Deploy infrastructure
terraform apply
```

**Save these outputs:**
```bash
terraform output > ../outputs.txt
```

#### Step 2: Configure Kubernetes (2-3 minutes)

```bash
# Get cluster name
CLUSTER_NAME=$(cd terraform && terraform output -raw eks_cluster_name)

# Configure kubectl
aws eks update-kubeconfig --region us-east-1 --name $CLUSTER_NAME

# Verify connection
kubectl get nodes
```

#### Step 3: Update MongoDB Configuration (1 minute)

```bash
# Get MongoDB IP
MONGODB_IP=$(cd terraform && terraform output -raw mongodb_vm_public_ip)

# Update ConfigMap
sed -i "s/18.212.74.58/${MONGODB_IP}/g" k8s/configmap.yaml

# Verify
grep MONGODB_URI k8s/configmap.yaml
```

#### Step 4: Deploy Application (5-10 minutes)

```bash
# Run deployment script
./deploy.sh
```

---

## Deploy Application

### Build and Push Container Image

#### Option A: Using GitHub Actions (Automated)

1. Push code to GitHub:
   ```bash
   git add .
   git commit -m "Deploy Wiz Technical Exercise"
   git push origin main
   ```

2. GitHub Actions will automatically:
   - Build the Docker image
   - Scan for vulnerabilities with Trivy
   - Push to Amazon ECR
   - Tag with version and commit SHA

#### Option B: Manual Docker Build

```bash
# Configure ECR login
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.us-east-1.amazonaws.com

# Create ECR repository (if it doesn't exist)
aws ecr create-repository --repository-name todo-app --region us-east-1 || true

# Build image
cd app
docker build -t todo-app:latest .

# Tag image
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
docker tag todo-app:latest ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/todo-app:latest

# Push image
docker push ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/todo-app:latest
```

### Update Kubernetes Deployment

Update the image in `k8s/deployment.yaml`:

```bash
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
sed -i "s/512231857943/${AWS_ACCOUNT_ID}/g" k8s/deployment.yaml
```

---

## Verification & Demonstration

### 1. Verify Infrastructure Deployment

```bash
# Check VPC and subnets
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=wiz-exercise-vpc" --query 'Vpcs[0].VpcId'

# Check EKS cluster
aws eks describe-cluster --name wiz-exercise-cluster --query 'cluster.status'

# Check MongoDB VM
MONGODB_IP=$(cd terraform && terraform output -raw mongodb_vm_public_ip)
echo "MongoDB VM: ${MONGODB_IP}"
nc -zv ${MONGODB_IP} 22
nc -zv ${MONGODB_IP} 27017
```

### 2. Verify Kubernetes Deployment

```bash
# Check all resources
kubectl get all -n todo-app

# Check pods are running
kubectl get pods -n todo-app

# Check services
kubectl get svc -n todo-app

# Get LoadBalancer URL
kubectl get svc -n todo-app todo-app-loadbalancer -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
```

### 3. Verify wizexercise.txt File

**This is a critical demonstration requirement!**

```bash
# Get pod name
POD_NAME=$(kubectl get pods -n todo-app -l app=todo-app -o jsonpath='{.items[0].metadata.name}')

# Verify file exists in container
kubectl exec -it ${POD_NAME} -n todo-app -- cat /app/wizexercise.txt

# Expected output:
# Wiz Technical Exercise - Completed by Kalyan Tatavarti
# This file demonstrates that custom files can be embedded into container images...
```

**Alternative verification methods:**
```bash
# Method 1: Check all pods
kubectl exec -n todo-app deployment/todo-app -- cat /app/wizexercise.txt

# Method 2: Verify file in Docker image locally
docker run --rm ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/todo-app:latest cat /app/wizexercise.txt
```

### 4. Verify Cluster Admin Privileges (INSECURE - BY DESIGN)

**This demonstrates the intentionally insecure configuration:**

```bash
# Check ServiceAccount
kubectl get serviceaccount todo-app-admin -n todo-app

# Check ClusterRoleBinding
kubectl get clusterrolebinding todo-app-admin-binding

# Verify pods are using the ServiceAccount
kubectl get pods -n todo-app -o jsonpath='{.items[0].spec.serviceAccountName}'

# Test admin access from within pod
POD_NAME=$(kubectl get pods -n todo-app -l app=todo-app -o jsonpath='{.items[0].metadata.name}')
kubectl exec -it ${POD_NAME} -n todo-app -- sh -c "ls -la /var/run/secrets/kubernetes.io/serviceaccount/"
```

### 5. Verify Application Functionality

```bash
# Get LoadBalancer URL
LB_URL=$(kubectl get svc -n todo-app todo-app-loadbalancer -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

# Test application
curl http://${LB_URL}/health

# Access in browser
echo "Open in browser: http://${LB_URL}"
```

### 6. Verify MongoDB Connectivity

```bash
# SSH to MongoDB VM
MONGODB_IP=$(cd terraform && terraform output -raw mongodb_vm_public_ip)
ssh ubuntu@${MONGODB_IP}

# Once connected, check MongoDB
sudo systemctl status mongod
mongo --version
mongo --eval "db.adminCommand('listDatabases')"

# Check backups
ls -lh /var/backups/mongodb/
cat /var/log/mongodb-backup.log

# Check cron job
crontab -l | grep backup
```

### 7. Verify S3 Backups (PUBLIC - INSECURE)

```bash
# List backups in S3
S3_BUCKET=$(cd terraform && terraform output -raw mongodb_backup_bucket)
aws s3 ls s3://${S3_BUCKET}/

# Verify public access (INTENTIONALLY INSECURE)
BACKUP_FILE=$(aws s3 ls s3://${S3_BUCKET}/ | tail -1 | awk '{print $4}')
echo "Public URL: https://${S3_BUCKET}.s3.amazonaws.com/${BACKUP_FILE}"

# Test public download (should work without credentials)
curl -I https://${S3_BUCKET}.s3.amazonaws.com/${BACKUP_FILE}
```

### 8. Verify Security Vulnerabilities (Intentional)

Run the security verification script:

```bash
./scripts/verify-security-issues.sh
```

This will check for all intentional misconfigurations:
- ✅ Outdated Ubuntu 18.04
- ✅ Outdated MongoDB 4.0.28
- ✅ SSH exposed to 0.0.0.0/0
- ✅ MongoDB exposed to 0.0.0.0/0
- ✅ Public S3 bucket
- ✅ Weak passwords
- ✅ Overly permissive IAM role
- ✅ Cluster-admin privileges on pods

---

## Demonstration Checklist

Use this checklist during your presentation:

### Infrastructure Demonstration
- [ ] Show Terraform code and explain architecture
- [ ] Show AWS Console with deployed resources (VPC, EKS, EC2, S3)
- [ ] Demonstrate kubectl access to cluster
- [ ] Show running pods and services

### Application Demonstration
- [ ] Access web application via LoadBalancer URL
- [ ] Create a todo item
- [ ] Show data persists in MongoDB
- [ ] Demonstrate wizexercise.txt file in container: `kubectl exec -it <pod> -n todo-app -- cat /app/wizexercise.txt`

### Security Vulnerabilities Demonstration
- [ ] Show outdated OS version: `ssh ubuntu@<mongodb-ip> "lsb_release -a"`
- [ ] Show outdated MongoDB: `ssh ubuntu@<mongodb-ip> "mongo --version"`
- [ ] Show public SSH access: `aws ec2 describe-security-groups --filters "Name=tag:Name,Values=*mongodb*"`
- [ ] Show public S3 bucket: Access backup URL in browser without credentials
- [ ] Show overly permissive IAM: `aws iam get-role-policy --role-name <mongodb-role> --policy-name <policy>`
- [ ] Show cluster-admin privileges: `kubectl get clusterrolebinding todo-app-admin-binding -o yaml`

### CI/CD Demonstration
- [ ] Show GitHub Actions workflows
- [ ] Show security scanning results (Trivy, tfsec, Checkov)
- [ ] Demonstrate automated image builds
- [ ] Show terraform deployment workflow

---

## Cleanup

### Complete Environment Teardown

```bash
# Option 1: Automated cleanup
./scripts/cleanup-all.sh

# Option 2: Manual cleanup
# Delete Kubernetes resources
kubectl delete namespace todo-app

# Wait for LoadBalancer to be deleted (important!)
sleep 60

# Destroy infrastructure
cd terraform
terraform destroy -auto-approve
```

**Important:** Wait for the LoadBalancer to be fully deleted before running `terraform destroy`, otherwise it may leave orphaned resources.

### Verify Cleanup

```bash
# Check no EKS clusters
aws eks list-clusters

# Check no EC2 instances
aws ec2 describe-instances --filters "Name=tag:Project,Values=wiz-exercise" --query 'Reservations[*].Instances[*].[InstanceId,State.Name]'

# Check S3 buckets (may need manual deletion if not empty)
aws s3 ls | grep wiz-exercise
```

---

## Troubleshooting

### Common Issues

#### 1. Terraform fails with "bucket name already exists"
```bash
# Edit terraform.tfvars and change mongodb_backup_bucket to a unique name
nano terraform/terraform.tfvars
# Change: mongodb_backup_bucket = "mongodb-backups-wiz-<your-unique-suffix>"
```

#### 2. Pods not starting
```bash
# Check pod logs
kubectl logs -n todo-app -l app=todo-app

# Check events
kubectl get events -n todo-app --sort-by='.lastTimestamp'

# Check if image exists in ECR
aws ecr describe-images --repository-name todo-app --region us-east-1
```

#### 3. Cannot connect to MongoDB from application
```bash
# Verify MongoDB is running
ssh ubuntu@<mongodb-ip> "sudo systemctl status mongod"

# Check security groups allow traffic
aws ec2 describe-security-groups --group-ids <sg-id>

# Verify ConfigMap has correct IP
kubectl get configmap todo-app-config -n todo-app -o yaml
```

#### 4. LoadBalancer not getting external IP
```bash
# Check service status
kubectl describe svc todo-app-loadbalancer -n todo-app

# This can take 2-3 minutes - be patient
# Check AWS console for ELB creation status
```

---

## Time Estimates

| Phase | Estimated Time |
|-------|---------------|
| Prerequisites installation | 10-15 minutes |
| Terraform infrastructure deployment | 15-20 minutes |
| Container build and push | 5-10 minutes |
| Kubernetes deployment | 5-10 minutes |
| **Total deployment time** | **35-55 minutes** |
| Verification and testing | 10-15 minutes |
| **Total time to fully functional** | **45-70 minutes** |

---

## Support

For issues or questions:
1. Check `DEPLOYMENT_GUIDE.md` for detailed explanations
2. Review `README.md` for architecture overview
3. See `GITHUB_ACTIONS_SETUP.md` for CI/CD setup
4. Check terraform outputs: `cd terraform && terraform output`

---

## Next Steps

After successful deployment:

1. **Prepare your presentation** using the provided template
2. **Document the security findings** you'll discuss
3. **Practice the live demonstration** using the verification steps
4. **Prepare to discuss:**
   - Your approach and methodology
   - Challenges faced and solutions
   - Security vulnerabilities and their impact
   - How Wiz could help detect these issues

Good luck with your Wiz Technical Exercise presentation! 🚀
